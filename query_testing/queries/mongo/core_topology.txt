[
    {
        "$match": {
            "timestamp": {
                "$gte": "2025-03-28T00:00:00.000Z",
                "$lte": "2025-03-28T23:59:59.999Z"
            },
            "meta.device_info.role": "Core Router",
            "meta.admin_status": "up",
            "meta.port_name": { "$exists": false },
            "meta.org.types": { "$ne": "ESnet Site" },
            "meta.org.hide": { "$ne": true }
        }
    },
    {
        "$group": {
            "_id": {
                "local_name": { "$ifNull": ["$meta.device_info.loc_name", null] },
                "remote_name": { "$ifNull": ["$meta.remote.loc_name", null] },
                "device": { "$ifNull": ["$meta.device", null] },
                "name": { "$ifNull": ["$meta.name", "-"] },
                "speed": { "$ifNull": ["$meta.speed", 0] }
            },
            "doc_count": { "$sum": 1 }
        }
    },
    {
        "$sort": {
            "_id.local_name": -1,
            "_id.remote_name": -1,
            "_id.device": -1,
            "_id.name": -1,
            "_id.speed": -1
        }
    },
    {
        "$project": {
            "_id": 0,
            "local_name": "$_id.local_name",
            "remote_name": "$_id.remote_name",
            "device": "$_id.device",
            "name": "$_id.name",
            "speed": "$_id.speed",
            "doc_count": "$doc_count"
        }
    }
]
